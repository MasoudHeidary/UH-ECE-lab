

from tool.log import Log
from tool import NBTI_formula as BTI
from msimulator.Multiplier import Wallace_rew
from msimulator.bin_func import signed_b
from alpha import AlphaMultiprocess
from alpha_shrinked import AlphaSampled

from mapping_tgate_pb_delay import tgate_pb_to_delay
from mapping_pmos_vth_body import pmos_vth_to_body

import random

BIT_LEN = 16
# SAMPLE = 300_000
SAMPLE = 1

# IN_ALPHA_SAMPLE = 1000
# SAMPLE = SAMPLE // IN_ALPHA_SAMPLE

TEMP = 273.15 + 80
# AGE_TIME = (200-1) * 7 *24*60*60      # 4 year
AGE_TIME = (50) * 7 *24*60*60           # 1 year
# AGE_TIME = 100                        # t=0 basically

########################################################################################
################## Rewiring List
########################################################################################
REW_LST = None
ALPHA_COUNTING_SAMPLE = None


if BIT_LEN == 8:
    ALPHA_COUNTING_SAMPLE = 40_000

    """no-mitigation"""
    # REW_LST = []

    """half critical-path"""
    # REW_LST =\
    # [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715)]


    """one critical-path"""
    # REW_LST =\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844)]

    """two critical-path"""
    # REW_LST = list(set(
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844)]      +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 1, 'A', 'B', 'C', 0)]
    # ))

    """full circuit tampering"""
    # REW_LST = list(set(
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844)]      +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 1, 'A', 'B', 'C', 0)]                        +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 1, 'A', 'C', 'B', 0.23806349924964598), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 2, 'A', 'B', 'C', 0)]                       +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 2, 'A', 'C', 'B', 0.23806349924964598), (2, 1, 'A', 'C', 'B', 0.22623808445886484), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 3, 'A', 'B', 'C', 0)]                      +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 3, 'A', 'C', 'B', 0.23806349924964598), (2, 2, 'A', 'C', 'B', 0.22623808445886484), (3, 1, 'A', 'C', 'B', 0.21645413617042697), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 4, 'A', 'B', 'C', 0)]                     +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 4, 'A', 'C', 'B', 0.23806349924964598), (2, 3, 'A', 'C', 'B', 0.22623808445886484), (3, 2, 'A', 'C', 'B', 0.21645413617042697), (4, 1, 'A', 'C', 'B', 0.20805352247289927), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 5, 'A', 'B', 'C', 0)]                    +\
    #     [(6, 0, 'C', 'A', 'B', 0.559487579332143), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 5, 'A', 'C', 'B', 0.23806349924964598), (2, 4, 'A', 'C', 'B', 0.22623808445886484), (3, 3, 'A', 'C', 'B', 0.21645413617042697), (4, 2, 'A', 'C', 'B', 0.20805352247289927), (5, 1, 'A', 'C', 'B', 0.20508564098694648), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (0, 6, 'A', 'B', 'C', 0)]
    # ))
    
    """full circuit considering all the gates"""
    REW_LST =\
        [(6, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (6, 1, 'B', 'C', 'A', 0.2797437896660715), (1, 1, 'A', 'C', 'B', 0.23806349924964598), (1, 2, 'A', 'C', 'B', 0.23806349924964598), (1, 3, 'A', 'C', 'B', 0.23806349924964598), (1, 4, 'A', 'C', 'B', 0.23806349924964598), (1, 5, 'A', 'C', 'B', 0.23806349924964598), (2, 1, 'A', 'C', 'B', 0.22623808445886484), (2, 2, 'A', 'C', 'B', 0.22623808445886484), (2, 3, 'A', 'C', 'B', 0.22623808445886484), (2, 4, 'A', 'C', 'B', 0.22623808445886484), (3, 1, 'A', 'C', 'B', 0.21645413617042697), (3, 2, 'A', 'C', 'B', 0.21645413617042697), (3, 3, 'A', 'C', 'B', 0.21645413617042697), (4, 1, 'A', 'C', 'B', 0.20805352247289927), (4, 2, 'A', 'C', 'B', 0.20805352247289927), (5, 1, 'A', 'C', 'B', 0.20508564098694648), (5, 2, 'A', 'C', 'B', 0.20101528375126826), (4, 3, 'A', 'C', 'B', 0.20044518222289298), (5, 3, 'A', 'C', 'B', 0.20040745491586842), (3, 4, 'A', 'C', 'B', 0.1969030072855622), (5, 4, 'A', 'C', 'B', 0.19681078497950177), (4, 4, 'A', 'C', 'B', 0.19510048039437622), (5, 5, 'A', 'C', 'B', 0.194203408871786), (4, 5, 'A', 'C', 'B', 0.19249310428666044), (3, 5, 'A', 'C', 'B', 0.1907827997015351), (2, 5, 'A', 'C', 'B', 0.18584052248128324), (5, 6, 'A', 'C', 'B', 0.17836743759193058), (4, 6, 'A', 'C', 'B', 0.16769824540818262), (6, 2, 'A', 'C', 'B', 0.1596535794830523), (3, 6, 'A', 'C', 'B', 0.1437575168356166), (6, 3, 'A', 'C', 'B', 0.12236642437351741), (2, 6, 'C', 'A', 'B', 0.11587346153684991), (6, 4, 'A', 'C', 'B', 0.09636392598740745), (1, 6, 'C', 'A', 'B', 0.09518042500764795), (6, 5, 'C', 'A', 'B', 0.07807456592637296), (1, 7, 'B', 'C', 'A', 0.07595053370645316), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (6, 6, 'C', 'A', 'B', 0.050249677430165784), (2, 7, 'C', 'B', 'A', 0.012848333528830136), (3, 7, 'C', 'B', 'A', 0.005668012802252154), (6, 7, 'B', 'A', 'C', 0.0034385392482901844), (4, 7, 'C', 'B', 'A', 0.0028235333545586494), (5, 7, 'C', 'B', 'A', 0.0028235333545586494), (0, 1, 'A', 'B', 'C', 0), (0, 2, 'A', 'B', 'C', 0), (0, 3, 'A', 'B', 'C', 0), (0, 4, 'A', 'B', 'C', 0), (0, 5, 'A', 'B', 'C', 0), (0, 6, 'A', 'B', 'C', 0), (0, 7, 'A', 'B', 'C', 0)]
        

elif BIT_LEN == 6:
    ALPHA_COUNTING_SAMPLE = 2**12
    
    """6-bit M-1-100%"""
    # REW_LST = \
    #     [(0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (4, 0, 'C', 'A', 'B', 0.5548261609530758), (4, 1, 'B', 'C', 'A', 0.27623934203576533), (4, 2, 'A', 'C', 'B', 0.13976290483496429), (4, 3, 'A', 'C', 'B', 0.08558649194731616), (4, 4, 'C', 'A', 'B', 0.04410409370444246), (4, 5, 'B', 'A', 'C', 0.01562820271485621)]
    
    """M-All-100% full circuit tampering"""
    REW_LST = \
        [(4, 0, 'C', 'A', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (4, 1, 'B', 'C', 'A', 0.27623934203576533), (1, 1, 'A', 'C', 'B', 0.23806349924964598), (1, 2, 'A', 'C', 'B', 0.23806349924964598), (1, 3, 'A', 'C', 'B', 0.23806349924964598), (2, 1, 'A', 'C', 'B', 0.22623808445886484), (2, 2, 'A', 'C', 'B', 0.22623808445886484), (3, 1, 'A', 'C', 'B', 0.21645413617042697), (3, 2, 'A', 'C', 'B', 0.1969030072855622), (3, 3, 'A', 'C', 'B', 0.1907827997015351), (2, 3, 'A', 'C', 'B', 0.18584052248128324), (3, 4, 'A', 'C', 'B', 0.1437575168356166), (4, 2, 'A', 'C', 'B', 0.13976290483496429), (2, 4, 'C', 'A', 'B', 0.11587346153684991), (1, 4, 'C', 'A', 'B', 0.09518042500764795), (4, 3, 'A', 'C', 'B', 0.08558649194731616), (1, 5, 'B', 'C', 'A', 0.07595053370645316), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (4, 4, 'C', 'A', 'B', 0.04410409370444246), (4, 5, 'B', 'A', 'C', 0.01562820271485621), (2, 5, 'C', 'B', 'A', 0.012848333528830136), (3, 5, 'C', 'B', 'A', 0.005668012802252154), (0, 1, 'A', 'B', 'C', 0), (0, 2, 'A', 'B', 'C', 0), (0, 3, 'A', 'B', 'C', 0), (0, 4, 'A', 'B', 'C', 0), (0, 5, 'A', 'B', 'C', 0)]
    
elif BIT_LEN == 10:
    ALPHA_COUNTING_SAMPLE = 50_000
    
    """10-bit M-1-100%"""
    # REW_LST = \
    #     [(0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (6, 0, 'A', 'C', 'B', 0.559487579332143), (7, 0, 'A', 'C', 'B', 0.559487579332143), (8, 0, 'C', 'A', 'B', 0.559487579332143), (8, 1, 'A', 'C', 'B', 0.27974378966607144), (8, 2, 'A', 'C', 'B', 0.16752601088223223), (8, 3, 'A', 'C', 'B', 0.1318820895897786), (8, 4, 'A', 'C', 'B', 0.11401192182901981), (8, 5, 'A', 'C', 'B', 0.10202721396413394), (8, 6, 'C', 'A', 'B', 0.08961912187596943), (8, 7, 'C', 'A', 'B', 0.07844764707361834), (8, 8, 'C', 'A', 'B', 0.05196725706721206), (8, 9, 'A', 'B', 'C', 0)]
    
    """M-All-100% full circuit tampering"""
    REW_LST = \
        [(6, 0, 'A', 'C', 'B', 0.559487579332143), (7, 0, 'A', 'C', 'B', 0.559487579332143), (8, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.5548261609530758), (5, 0, 'A', 'C', 'B', 0.5548261609530758), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (8, 1, 'A', 'C', 'B', 0.27974378966607144), (1, 1, 'A', 'C', 'B', 0.23806349924964598), (1, 2, 'A', 'C', 'B', 0.23806349924964598), (1, 3, 'A', 'C', 'B', 0.23806349924964598), (1, 4, 'A', 'C', 'B', 0.23806349924964598), (1, 5, 'A', 'C', 'B', 0.23806349924964598), (1, 6, 'A', 'C', 'B', 0.23806349924964598), (1, 7, 'A', 'C', 'B', 0.23806349924964598), (2, 1, 'A', 'C', 'B', 0.22623808445886484), (2, 2, 'A', 'C', 'B', 0.22623808445886484), (2, 3, 'A', 'C', 'B', 0.22623808445886484), (2, 4, 'A', 'C', 'B', 0.22623808445886484), (2, 5, 'A', 'C', 'B', 0.22623808445886484), (2, 6, 'A', 'C', 'B', 0.22623808445886484), (3, 1, 'A', 'C', 'B', 0.21645413617042697), (3, 2, 'A', 'C', 'B', 0.21645413617042697), (3, 3, 'A', 'C', 'B', 0.21645413617042697), (3, 4, 'A', 'C', 'B', 0.21645413617042697), (3, 5, 'A', 'C', 'B', 0.21645413617042697), (4, 1, 'A', 'C', 'B', 0.20805352247289927), (4, 2, 'A', 'C', 'B', 0.20805352247289927), (4, 3, 'A', 'C', 'B', 0.20805352247289927), (4, 4, 'A', 'C', 'B', 0.20805352247289927), (5, 1, 'A', 'C', 'B', 0.20508564098694648), (5, 2, 'A', 'C', 'B', 0.20508564098694648), (5, 3, 'A', 'C', 'B', 0.20508564098694648), (6, 1, 'A', 'C', 'B', 0.20220998180705446), (6, 2, 'A', 'C', 'B', 0.20220998180705446), (7, 1, 'A', 'C', 'B', 0.20220159796104858), (7, 2, 'A', 'C', 'B', 0.20220159796104858), (5, 4, 'A', 'C', 'B', 0.20101528375126826), (4, 5, 'A', 'C', 'B', 0.20044518222289298), (5, 5, 'A', 'C', 'B', 0.20040745491586842), (7, 5, 'A', 'C', 'B', 0.20038649530085484), (6, 3, 'A', 'C', 'B', 0.19987927261752092), (7, 3, 'A', 'C', 'B', 0.19987088877151504), (7, 4, 'A', 'C', 'B', 0.19926725185911814), (6, 5, 'A', 'C', 'B', 0.19866780686972374), (6, 4, 'A', 'C', 'B', 0.19754856342798738), (3, 6, 'A', 'C', 'B', 0.1969030072855622), (5, 6, 'A', 'C', 'B', 0.19681078497950177), (7, 6, 'A', 'C', 'B', 0.1967814415184821), (7, 7, 'A', 'C', 'B', 0.19592209730291676), (4, 6, 'A', 'C', 'B', 0.19510048039437622), (6, 6, 'A', 'C', 'B', 0.19506275308735133), (5, 7, 'A', 'C', 'B', 0.194203408871786), (6, 7, 'A', 'C', 'B', 0.194203408871786), (4, 7, 'A', 'C', 'B', 0.19249310428666044), (3, 7, 'A', 'C', 'B', 0.1907827997015351), (7, 8, 'A', 'C', 'B', 0.1891958714500634), (6, 8, 'A', 'C', 'B', 0.1873645921946439), (2, 7, 'A', 'C', 'B', 0.18584052248128324), (5, 8, 'A', 'C', 'B', 0.17836743759193058), (4, 8, 'A', 'C', 'B', 0.16769824540818262), (8, 2, 'A', 'C', 'B', 0.16752601088223223), (3, 8, 'A', 'C', 'B', 0.1437575168356166), (8, 3, 'A', 'C', 'B', 0.1318820895897786), (2, 8, 'C', 'A', 'B', 0.11587346153684991), (8, 4, 'A', 'C', 'B', 0.11401192182901981), (8, 5, 'A', 'C', 'B', 0.10202721396413394), (1, 8, 'C', 'A', 'B', 0.09518042500764795), (8, 6, 'C', 'A', 'B', 0.08961912187596943), (8, 7, 'C', 'A', 'B', 0.07844764707361834), (1, 9, 'B', 'C', 'A', 0.07595053370645316), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (8, 8, 'C', 'A', 'B', 0.05196725706721206), (2, 9, 'C', 'B', 'A', 0.012848333528830136), (3, 9, 'C', 'B', 'A', 0.005668012802252154), (4, 9, 'C', 'B', 'A', 0.0028235333545586494), (5, 9, 'C', 'B', 'A', 0.0028235333545586494), (0, 1, 'A', 'B', 'C', 0), (0, 2, 'A', 'B', 'C', 0), (0, 3, 'A', 'B', 'C', 0), (0, 4, 'A', 'B', 'C', 0), (0, 5, 'A', 'B', 'C', 0), (0, 6, 'A', 'B', 'C', 0), (0, 7, 'A', 'B', 'C', 0), (0, 8, 'A', 'B', 'C', 0), (0, 9, 'A', 'B', 'C', 0), (6, 9, 'A', 'B', 'C', 0), (7, 9, 'A', 'B', 'C', 0), (8, 9, 'A', 'B', 'C', 0)]
    
elif BIT_LEN == 16:
    ALPHA_COUNTING_SAMPLE =  50_000
    
    """M-1-100% critical path tampering"""
    # REW_LST = \
    #     [(5, 0, 'A', 'C', 'B', 0.559487579332143), (6, 0, 'A', 'C', 'B', 0.559487579332143), (7, 0, 'A', 'C', 'B', 0.559487579332143), (8, 0, 'A', 'C', 'B', 0.559487579332143), (9, 0, 'A', 'C', 'B', 0.559487579332143), (10, 0, 'A', 'C', 'B', 0.559487579332143), (11, 0, 'A', 'C', 'B', 0.559487579332143), (12, 0, 'A', 'C', 'B', 0.559487579332143), (13, 0, 'A', 'C', 'B', 0.559487579332143), (14, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.552478684071531), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (14, 1, 'A', 'C', 'B', 0.27974378966607144), (14, 2, 'A', 'C', 'B', 0.16901833547121398), (14, 3, 'A', 'C', 'B', 0.13654350796884568), (14, 4, 'A', 'C', 'B', 0.12157415092599572), (14, 5, 'A', 'C', 'B', 0.1113835861062904), (14, 6, 'A', 'C', 'B', 0.10663832926716804), (14, 7, 'A', 'C', 'B', 0.10257216395449248), (14, 8, 'A', 'C', 'B', 0.10257216395449248), (14, 9, 'C', 'A', 'B', 0.0979107455754254), (14, 10, 'C', 'A', 'B', 0.09673700713465283), (14, 11, 'C', 'A', 'B', 0.09438114640710249), (14, 12, 'C', 'A', 'B', 0.08961912187596943), (14, 13, 'C', 'A', 'B', 0.07844764707361834), (0, 0, 'C', 'A', 'B', 0.06218895051694939), (14, 14, 'C', 'A', 'B', 0.05194212175545043), (14, 15, 'A', 'B', 'C', 0)]
    
    """M-All-100% full circuit tampering"""
    REW_LST = \
        [(5, 0, 'A', 'C', 'B', 0.559487579332143), (6, 0, 'A', 'C', 'B', 0.559487579332143), (7, 0, 'A', 'C', 'B', 0.559487579332143), (8, 0, 'A', 'C', 'B', 0.559487579332143), (9, 0, 'A', 'C', 'B', 0.559487579332143), (10, 0, 'A', 'C', 'B', 0.559487579332143), (11, 0, 'A', 'C', 'B', 0.559487579332143), (12, 0, 'A', 'C', 'B', 0.559487579332143), (13, 0, 'A', 'C', 'B', 0.559487579332143), (14, 0, 'C', 'A', 'B', 0.559487579332143), (4, 0, 'A', 'C', 'B', 0.552478684071531), (3, 0, 'A', 'C', 'B', 0.5501312071899864), (2, 0, 'A', 'C', 'B', 0.5406406935117418), (1, 0, 'A', 'C', 'B', 0.5237137084266037), (14, 1, 'A', 'C', 'B', 0.27974378966607144), (1, 1, 'A', 'C', 'B', 0.23806349924964598), (1, 2, 'A', 'C', 'B', 0.23806349924964598), (1, 3, 'A', 'C', 'B', 0.23806349924964598), (1, 4, 'A', 'C', 'B', 0.23806349924964598), (1, 5, 'A', 'C', 'B', 0.23806349924964598), (1, 6, 'A', 'C', 'B', 0.23806349924964598), (1, 7, 'A', 'C', 'B', 0.23806349924964598), (1, 8, 'A', 'C', 'B', 0.23806349924964598), (1, 9, 'A', 'C', 'B', 0.23806349924964598), (1, 10, 'A', 'C', 'B', 0.23806349924964598), (1, 11, 'A', 'C', 'B', 0.23806349924964598), (1, 12, 'A', 'C', 'B', 0.23806349924964598), (1, 13, 'A', 'C', 'B', 0.23806349924964598), (2, 2, 'A', 'C', 'B', 0.22623808445886484), (2, 3, 'A', 'C', 'B', 0.22623808445886484), (2, 4, 'A', 'C', 'B', 0.22623808445886484), (2, 6, 'A', 'C', 'B', 0.22623808445886484), (2, 9, 'A', 'C', 'B', 0.22623808445886484), (2, 12, 'A', 'C', 'B', 0.22623808445886484), (2, 1, 'A', 'C', 'B', 0.22468707294784407), (2, 5, 'A', 'C', 'B', 0.22468707294784407), (2, 11, 'A', 'C', 'B', 0.22468707294784407), (2, 7, 'A', 'C', 'B', 0.22441040602966233), (2, 8, 'A', 'C', 'B', 0.22285939451864156), (2, 10, 'A', 'C', 'B', 0.22285939451864156), (3, 1, 'A', 'C', 'B', 0.21645413617042697), (3, 2, 'A', 'C', 'B', 0.21645413617042697), (3, 3, 'A', 'C', 'B', 0.21645413617042697), (3, 4, 'A', 'C', 'B', 0.21645413617042697), (3, 5, 'A', 'C', 'B', 0.21645413617042697), (3, 6, 'A', 'C', 'B', 0.21645413617042697), (3, 7, 'A', 'C', 'B', 0.21645413617042697), (3, 8, 'A', 'C', 'B', 0.21645413617042697), (3, 9, 'A', 'C', 'B', 0.21645413617042697), (3, 10, 'A', 'C', 'B', 0.21645413617042697), (3, 11, 'A', 'C', 'B', 0.21645413617042697), (4, 1, 'A', 'C', 'B', 0.2103842316624328), (4, 5, 'A', 'C', 'B', 0.2103842316624328), (4, 10, 'A', 'C', 'B', 0.2103842316624328), (4, 2, 'A', 'C', 'B', 0.20976382705802482), (4, 4, 'A', 'C', 'B', 0.20976382705802482), (4, 9, 'A', 'C', 'B', 0.20976382705802482), (5, 2, 'A', 'C', 'B', 0.20916438206863014), (4, 8, 'A', 'C', 'B', 0.20859008861725226), (4, 3, 'A', 'C', 'B', 0.20805352247289927), (4, 6, 'A', 'C', 'B', 0.20805352247289927), (4, 7, 'A', 'C', 'B', 0.20805352247289927), (5, 9, 'A', 'C', 'B', 0.20741635017648002), (6, 3, 'A', 'C', 'B', 0.20739539056146644), (5, 3, 'A', 'C', 'B', 0.2068336728790966), (5, 4, 'A', 'C', 'B', 0.2068336728790966), (5, 1, 'A', 'C', 'B', 0.20508564098694648), (5, 5, 'A', 'C', 'B', 0.20508564098694648), (5, 6, 'A', 'C', 'B', 0.20508564098694648), (5, 7, 'A', 'C', 'B', 0.20508564098694648), (5, 8, 'A', 'C', 'B', 0.20508564098694648), (6, 1, 'A', 'C', 'B', 0.20220998180705446), (6, 2, 'A', 'C', 'B', 0.20220998180705446), (6, 4, 'A', 'C', 'B', 0.20220998180705446), (6, 5, 'A', 'C', 'B', 0.20220998180705446), (6, 6, 'A', 'C', 'B', 0.20220998180705446), (6, 7, 'A', 'C', 'B', 0.20220998180705446), (6, 8, 'A', 'C', 'B', 0.20220998180705446), (7, 2, 'A', 'C', 'B', 0.20220159796104858), (7, 4, 'A', 'C', 'B', 0.20220159796104858), (7, 6, 'A', 'C', 'B', 0.20220159796104858), (7, 8, 'A', 'C', 'B', 0.20220159796104858), (8, 3, 'A', 'C', 'B', 0.20220159796104858), (8, 9, 'A', 'C', 'B', 0.20220159796104858), (5, 10, 'A', 'C', 'B', 0.20101528375126826), (7, 1, 'A', 'C', 'B', 0.20048290952991782), (7, 3, 'A', 'C', 'B', 0.20048290952991782), (7, 5, 'A', 'C', 'B', 0.20048290952991782), (7, 7, 'A', 'C', 'B', 0.20048290952991782), (8, 1, 'A', 'C', 'B', 0.20048290952991782), (8, 2, 'A', 'C', 'B', 0.20048290952991782), (8, 4, 'A', 'C', 'B', 0.20048290952991782), (8, 5, 'A', 'C', 'B', 0.20048290952991782), (8, 6, 'A', 'C', 'B', 0.20048290952991782), (8, 8, 'A', 'C', 'B', 0.20048290952991782), (9, 1, 'A', 'C', 'B', 0.20048290952991782), (9, 2, 'A', 'C', 'B', 0.20048290952991782), (9, 3, 'A', 'C', 'B', 0.20048290952991782), (9, 5, 'A', 'C', 'B', 0.20048290952991782), (9, 6, 'A', 'C', 'B', 0.20048290952991782), (9, 8, 'A', 'C', 'B', 0.20048290952991782), (10, 1, 'A', 'C', 'B', 0.20048290952991782), (10, 2, 'A', 'C', 'B', 0.20048290952991782), (10, 3, 'A', 'C', 'B', 0.20048290952991782), (10, 4, 'A', 'C', 'B', 0.20048290952991782), (10, 5, 'A', 'C', 'B', 0.20048290952991782), (10, 6, 'A', 'C', 'B', 0.20048290952991782), (10, 7, 'A', 'C', 'B', 0.20048290952991782), (10, 8, 'A', 'C', 'B', 0.20048290952991782), (11, 1, 'A', 'C', 'B', 0.20048290952991782), (11, 2, 'A', 'C', 'B', 0.20048290952991782), (11, 3, 'A', 'C', 'B', 0.20048290952991782), (11, 4, 'A', 'C', 'B', 0.20048290952991782), (11, 5, 'A', 'C', 'B', 0.20048290952991782), (11, 6, 'A', 'C', 'B', 0.20048290952991782), (11, 7, 'A', 'C', 'B', 0.20048290952991782), (11, 8, 'A', 'C', 'B', 0.20048290952991782), (12, 2, 'A', 'C', 'B', 0.20048290952991782), (12, 3, 'A', 'C', 'B', 0.20048290952991782), (12, 4, 'A', 'C', 'B', 0.20048290952991782), (12, 5, 'A', 'C', 'B', 0.20048290952991782), (12, 6, 'A', 'C', 'B', 0.20048290952991782), (12, 7, 'A', 'C', 'B', 0.20048290952991782), (12, 8, 'A', 'C', 'B', 0.20048290952991782), (13, 1, 'A', 'C', 'B', 0.20048290952991782), (13, 2, 'A', 'C', 'B', 0.20048290952991782), (13, 3, 'A', 'C', 'B', 0.20048290952991782), (13, 4, 'A', 'C', 'B', 0.20048290952991782), (13, 5, 'A', 'C', 'B', 0.20048290952991782), (13, 6, 'A', 'C', 'B', 0.20048290952991782), (13, 7, 'A', 'C', 'B', 0.20048290952991782), (13, 8, 'A', 'C', 'B', 0.20048290952991782), (4, 11, 'A', 'C', 'B', 0.20044518222289298), (6, 9, 'A', 'C', 'B', 0.19987927261752092), (9, 9, 'A', 'C', 'B', 0.19987088877151504), (13, 9, 'A', 'C', 'B', 0.19987088877151504), (8, 7, 'A', 'C', 'B', 0.19876422109878705), (9, 4, 'A', 'C', 'B', 0.19876422109878705), (9, 7, 'A', 'C', 'B', 0.19876422109878705), (12, 1, 'A', 'C', 'B', 0.19876422109878705), (5, 11, 'A', 'C', 'B', 0.19866780686972374), (7, 11, 'A', 'C', 'B', 0.19866780686972374), (7, 9, 'A', 'C', 'B', 0.19815220034038428), (10, 9, 'A', 'C', 'B', 0.19815220034038428), (11, 9, 'A', 'C', 'B', 0.19815220034038428), (12, 9, 'A', 'C', 'B', 0.19815220034038428), (6, 10, 'A', 'C', 'B', 0.19754856342798738), (7, 10, 'A', 'C', 'B', 0.1975401795819815), (8, 10, 'A', 'C', 'B', 0.1975401795819815), (9, 10, 'A', 'C', 'B', 0.1975401795819815), (10, 10, 'A', 'C', 'B', 0.1975401795819815), (11, 10, 'A', 'C', 'B', 0.1975401795819815), (12, 10, 'A', 'C', 'B', 0.1975401795819815), (13, 10, 'A', 'C', 'B', 0.1975401795819815), (6, 11, 'A', 'C', 'B', 0.19749406842895117), (9, 11, 'A', 'C', 'B', 0.19691977497757363), (10, 11, 'A', 'C', 'B', 0.19691977497757363), (11, 11, 'A', 'C', 'B', 0.19691977497757363), (13, 11, 'A', 'C', 'B', 0.19691977497757363), (3, 12, 'A', 'C', 'B', 0.1969030072855622), (4, 12, 'A', 'C', 'B', 0.19681078497950177), (8, 12, 'A', 'C', 'B', 0.1967814415184821), (10, 12, 'A', 'C', 'B', 0.1967814415184821), (11, 12, 'A', 'C', 'B', 0.1967814415184821), (13, 12, 'A', 'C', 'B', 0.1967814415184821), (8, 13, 'A', 'C', 'B', 0.19592209730291676), (9, 13, 'A', 'C', 'B', 0.19592209730291676), (10, 13, 'A', 'C', 'B', 0.19592209730291676), (11, 13, 'A', 'C', 'B', 0.19592209730291676), (12, 13, 'A', 'C', 'B', 0.19592209730291676), (13, 13, 'A', 'C', 'B', 0.19592209730291676), (8, 11, 'A', 'C', 'B', 0.19520108654644286), (5, 12, 'A', 'C', 'B', 0.19506275308735133), (6, 12, 'A', 'C', 'B', 0.19506275308735133), (7, 12, 'A', 'C', 'B', 0.19506275308735133), (9, 12, 'A', 'C', 'B', 0.19506275308735133), (12, 12, 'A', 'C', 'B', 0.19506275308735133), (5, 13, 'A', 'C', 'B', 0.194203408871786), (6, 13, 'A', 'C', 'B', 0.194203408871786), (7, 13, 'A', 'C', 'B', 0.194203408871786), (12, 11, 'A', 'C', 'B', 0.1940273481056703), (11, 14, 'A', 'C', 'B', 0.1927410939903031), (12, 14, 'A', 'C', 'B', 0.1927410939903031), (13, 14, 'A', 'C', 'B', 0.1927410939903031), (4, 13, 'A', 'C', 'B', 0.19249310428666044), (8, 14, 'A', 'C', 'B', 0.1909140053052623), (9, 14, 'A', 'C', 'B', 0.1909140053052623), (10, 14, 'A', 'C', 'B', 0.1909140053052623), (3, 13, 'A', 'C', 'B', 0.1907827997015351), (7, 14, 'A', 'C', 'B', 0.19060390309725056), (6, 14, 'A', 'C', 'B', 0.1873645921946439), (2, 13, 'A', 'C', 'B', 0.18584052248128324), (5, 14, 'A', 'C', 'B', 0.17836743759193058), (14, 2, 'A', 'C', 'B', 0.16901833547121398), (4, 14, 'A', 'C', 'B', 0.16769824540818262), (3, 14, 'A', 'C', 'B', 0.1437575168356166), (14, 3, 'A', 'C', 'B', 0.13654350796884568), (14, 4, 'A', 'C', 'B', 0.12157415092599572), (2, 14, 'C', 'A', 'B', 0.11587346153684991), (14, 5, 'A', 'C', 'B', 0.1113835861062904), (14, 6, 'A', 'C', 'B', 0.10663832926716804), (14, 7, 'A', 'C', 'B', 0.10257216395449248), (14, 8, 'A', 'C', 'B', 0.10257216395449248), (14, 9, 'C', 'A', 'B', 0.0979107455754254), (14, 10, 'C', 'A', 'B', 0.09673700713465283), (1, 14, 'C', 'A', 'B', 0.09518042500764795), (14, 11, 'C', 'A', 'B', 0.09438114640710249), (14, 12, 'C', 'A', 'B', 0.08961912187596943), (14, 13, 'C', 'A', 'B', 0.07844764707361834), (1, 15, 'B', 'C', 'A', 0.07412403438510667), (0, 0, 'C', 'A', 'B', 0.06218895051694939), (14, 14, 'C', 'A', 'B', 0.05194212175545043), (2, 15, 'C', 'B', 'A', 0.012848333528830136), (3, 15, 'C', 'B', 'A', 0.005668012802252154), (5, 15, 'C', 'B', 'A', 0.0042311108132110364), (0, 15, 'A', 'C', 'B', 0.0034351592740922143), (4, 15, 'C', 'B', 'A', 0.0028235333545586494), (0, 4, 'B', 'A', 'C', 0.0017175796370459406), (0, 6, 'A', 'C', 'B', 0.0017175796370459406), (0, 7, 'B', 'A', 'C', 0.0017175796370459406), (0, 10, 'A', 'C', 'B', 0.0017175796370459406), (0, 11, 'A', 'C', 'B', 0.0017175796370459406), (0, 14, 'B', 'A', 'C', 0.0017175796370459406), (8, 15, 'B', 'A', 'C', 0.0017175796370459406), (0, 1, 'A', 'B', 'C', 0), (0, 2, 'A', 'B', 'C', 0), (0, 3, 'A', 'B', 'C', 0), (0, 5, 'A', 'B', 'C', 0), (0, 8, 'A', 'B', 'C', 0), (0, 9, 'A', 'B', 'C', 0), (0, 12, 'A', 'B', 'C', 0), (0, 13, 'A', 'B', 'C', 0), (6, 15, 'A', 'B', 'C', 0), (7, 15, 'A', 'B', 'C', 0), (9, 15, 'A', 'B', 'C', 0), (10, 15, 'A', 'B', 'C', 0), (11, 15, 'A', 'B', 'C', 0), (12, 15, 'A', 'B', 'C', 0), (13, 15, 'A', 'B', 'C', 0), (14, 15, 'A', 'B', 'C', 0)]


if REW_LST == None:
    raise RuntimeError("REW_LST is NONE, the defined Bit Length does not have corresponding rewiring")

log = Log(f"{__file__}.bit{BIT_LEN}.REW{len(REW_LST)}.log", terminal=True)
DUMP_RAW = True

########################## potential critical path list

path_lst = []

"""auto, all critical path"""
def create_crit(i_th):
    crit = []
    for lay in range(0, BIT_LEN-2):
        crit += [
            (lay, max(i_th - lay, 0))
        ]
    crit += [(BIT_LEN-2, i) for i in range(BIT_LEN)]
    return crit

for i_th in range(BIT_LEN-1):
    path_lst += [create_crit(i_th)]

log.println(f"[{BIT_LEN}] path list: \n{path_lst}")


########################## functions

def get_alpha(raw_mp, bit_len, log=False, rew_lst=[], verify=False):
    return AlphaMultiprocess(raw_mp, bit_len, log=log, rew_lst=rew_lst).run()

def get_alpha_sample(raw_mp, bit_len, rew_lst, sample_count, rnd_seed, log=False):
    return AlphaSampled(raw_mp, bit_len, rew_lst).run_multi(sample_count, rnd_seed, log)

def get_monte_alpha(raw_mp, bit_len, sample_count, in_alpha, seed, log=False, rew_lst=[], verify=False):
    
    # alpah structure as counter
    alpha_row = bit_len - 1
    alpha_index = bit_len
    alpha = [
        [
            [0 for _ in range(6)]
            for _ in range(alpha_index)
        ]
        for _ in range(alpha_row)
    ]

    # counting alpha
    random.seed(seed)
    for alpha_sample_i in range(sample_count):
        a_bin = [
            random.choices([0,1], weights=[in_alpha['A'][bit], 1-in_alpha['A'][bit]], k=1)[0]
            for bit in range(bit_len)
        ]
        b_bin = [
            random.choices([0,1], weights=[in_alpha['B'][bit], 1-in_alpha['B'][bit]], k=1)[0]
            for bit in range(bit_len)
        ]

        mp = raw_mp(a_bin, b_bin, bit_len, rew_lst)
        mp.output

        #TODO: verify

        for row in range(alpha_row):
            for index in range(alpha_index):
                for t in range(6):
                    alpha[row][index][t] += (not mp.gfa[row][index].p[t])

    
    # alpha counter -> alpha probability
    for row in range(alpha_row):
        for index in range(alpha_index):
            for t in range(6):
                alpha[row][index][t] /= sample_count
    return alpha

def seed_generator(sample_index):
    return 7*sample_index + 1

def generate_guassian_vth_base(bit_len, mu=0, sigma=0.05, base_vth=abs(BTI.Vth), seed=False):
    if seed:
        random.seed(seed)

    vth = [
        [[base_vth for _ in range(6)] for _ in range(bit_len)] for _ in range(bit_len-1)
    ]

    for fa_i in range(bit_len-1):
        for fa_j in range(bit_len):
            for t_index in range(6):
                vth_variation = random.gauss(mu, sigma)
                vth[fa_i][fa_j][t_index] *= (1 + vth_variation)

    return vth

def get_FA_delay(fa_alpha, temp, sec):
    tg1_alpha = max(fa_alpha[0], fa_alpha[1])
    tg1_vth = abs(BTI.Vth) + BTI.delta_vth(BTI.Vdef, temp, tg1_alpha, BTI.Tclk, sec)
    tg1_pb = pmos_vth_to_body(tg1_vth)

    tg2_alpha = max(fa_alpha[2], fa_alpha[3])
    tg2_vth = abs(BTI.Vth) + BTI.delta_vth(BTI.Vdef, temp, tg2_alpha, BTI.Tclk, sec)
    tg2_pb = pmos_vth_to_body(tg2_vth)

    return tgate_pb_to_delay(tg1_pb) + tgate_pb_to_delay(tg2_pb)


def get_MP_delay(critical_fa_lst, alpha, temp, sec):
    ps = 0
    for fa_lay, fa_i in critical_fa_lst:
        ps += get_FA_delay(alpha[fa_lay][fa_i], temp, sec)
    return ps

def get_monte_FA_delay(fa_vth, fa_alpha, temp, sec):
    tg1_vth_1 = fa_vth[0] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[0], BTI.Tclk, sec)
    tg1_vth_2 = fa_vth[1] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[1], BTI.Tclk, sec)
    tg1_vth = max(tg1_vth_1, tg1_vth_2)
    tg1_pb = pmos_vth_to_body(tg1_vth)

    tg2_vth_1 = fa_vth[2] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[2], BTI.Tclk, sec)
    tg2_vth_2 = fa_vth[3] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[3], BTI.Tclk, sec)
    tg2_vth = max(tg2_vth_1, tg2_vth_2)
    tg2_pb = pmos_vth_to_body(tg2_vth)

    # //fa_vth[4] fa_vth[5] ignored
    return tgate_pb_to_delay(tg1_pb) + tgate_pb_to_delay(tg2_pb)

def get_monte_FA_delay_matrix(bitlen, vth, alpha, temp, sec):
    fa_delay = [
        [get_monte_FA_delay(vth[fa_i][fa_j], alpha[fa_i][fa_j], temp, sec) for fa_j in range(bitlen)]
        for fa_i in range(bitlen - 1)
    ]
    return fa_delay

def get_monte_path_delay(vth_matrix, critical_fa_lst, alpha, temp, sec):
    ps = 0
    for fa_lay, fa_i in critical_fa_lst:
        ps += get_monte_FA_delay(vth_matrix[fa_lay][fa_i], alpha[fa_lay][fa_i], temp, sec)
    return ps

def get_monte_MP_delay(sample_id, path_lst, alpha, temp, sec):
    ps = 0
    vth_matrix = generate_guassian_vth_base(BIT_LEN, seed=seed_generator(sample_id))
    for path in path_lst:
        path_delay = get_monte_path_delay(vth_matrix, path, alpha, temp, sec)
        ps = max(ps, path_delay)
    return ps


"""get multiplier propagation delay for a specific input"""
def get_monte_pd(A, B, bitlen, fa_delay):
    # same function method, only the fa_delay is dependent on Vth matrix
    layer = bitlen-1
    index = bitlen
    mp = Wallace_rew(signed_b(A, bitlen), signed_b(B, bitlen), bitlen, rew_lst=[])
    mp.output
    
    ps_matrix = [
        [0 for _ in range(index)]
        for _ in range(layer)
    ]
    
    for fa_i in range(layer):
        for fa_j in range(index):
            if mp.gfa[fa_i][fa_j].sum or mp.gfa[fa_i][fa_j].carry:
                previous_block = 0

                # gate at top
                i, j = fa_i-1, fa_j+1
                if i >= 0 and j < bitlen and mp.gfa[i][j].sum:
                    d = ps_matrix[i][j]
                    previous_block = max(d, previous_block)
                
                # gate at top right
                i, j = fa_i-1, fa_j
                if i >=0 and mp.gfa[i][j].carry:
                    d = ps_matrix[i][j]
                    previous_block = max(d, previous_block)

                # gate at right (last row only)
                i, j = fa_i, fa_j-1
                if (i == bitlen-2) and j >= 0 and mp.gfa[i][j].carry:
                    d = ps_matrix[i][j]
                    previous_block = max(d, previous_block)
                
                ps_matrix[fa_i][fa_j] = fa_delay[fa_i][fa_j] + previous_block
    return max(value for row in ps_matrix for value in row)

def get_monte_error_rate(bitlen, vth, alpha, temp, sec, max_ps_delay):
    limit = 2 ** (bitlen - 1)
    length = 2 * limit

    error_counter = 0
    fa_delay = get_monte_FA_delay_matrix(bitlen, vth, alpha, temp, sec)
    for A in range(-limit, limit):
        for B in range(-limit, limit):
            pd = get_monte_pd(A, B, bitlen, fa_delay)
            if pd > max_ps_delay:
                error_counter += 1

    return error_counter / length

def get_monte_error_rate_sample(bitlen, vth, alpha, temp, sec, max_ps_delay, samples, rnd_seed):
    random.seed(rnd_seed)
    limit = 2 ** (bitlen - 1)
    fa_delay_matrix = get_monte_FA_delay_matrix(bitlen, vth, alpha, temp, sec)
    
    max_seen_delay = 0
    error_counter = 0
    for sample_i in range(samples):
        A = random.randint(-limit, limit-1)
        B = random.randint(-limit, limit-1)
        pd = get_monte_pd(A, B, bitlen, fa_delay_matrix)
        if pd > max_ps_delay:
            error_counter += 1
        max_seen_delay = max(max_seen_delay, pd)

    return error_counter/samples, max_seen_delay

########################## main

"""process variation monte carlo"""
if False and (__name__ == "__main__"):
    res = []

    log.println(f"RUNNING: monte carlo bit {BIT_LEN} with dynamic input alpha")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"config/SAMPLE: {SAMPLE}")
    log.println(f"config/REW_LST: [{len(REW_LST)}] {REW_LST}")

    alpha = get_alpha(Wallace_rew, BIT_LEN, log=False, rew_lst=REW_LST)
    for sample_id in range(SAMPLE):
        delay = get_monte_MP_delay(sample_id, path_lst, alpha, TEMP, AGE_TIME)
        res.append(delay)

        if sample_id % 10_000 == 0:
            log.println(f"REW_LEN [{len(REW_LST)}]: sample [{sample_id:10,}/{SAMPLE:10,}] DONE")

    log.println(f"REW LEN: {len(REW_LST)}")
    log.println(f"min: {min(res)}, max: {max(res)}, average {sum(res)/len(res)}")
    if DUMP_RAW:
        log.println(f"raw result: \n{res}")
    
    # delay from 0-1000 as counter, each delay increase by one
    _sample_per_delay = [0 for _ in range(2000)]
    for delay in res:
        _sample_per_delay[int(delay)] += 1
    log.println(f"_sample_per_delay:\n{_sample_per_delay} \n")



"""process variation + dynamic input alpha"""
if False and (__name__ == "__main__"):
    MIN_ALPHA = 0.1
    MAX_ALPHA = 0.9
    res = []

    log.println("-"*20)
    log.println(f"RUNNING: monte carlo bit {BIT_LEN} with dynamic input alpha")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"confing/IN_ALPHA_SAMPLE: {IN_ALPHA_SAMPLE}")
    log.println(f"config/SAMPLE: {SAMPLE}")
    log.println(f"config/REW_LST: [{len(REW_LST)}] {REW_LST}")
    log.println("-"*20)

    for in_alpha_i in range(IN_ALPHA_SAMPLE):
        random.seed(in_alpha_i)
        a_alpha = [random.uniform(MIN_ALPHA, MAX_ALPHA) for _ in range(BIT_LEN)]
        b_alpha = [random.uniform(MIN_ALPHA, MAX_ALPHA) for _ in range(BIT_LEN)]
        in_alpha = {'A': a_alpha, 'B': b_alpha}
        
        alpha = get_monte_alpha(Wallace_rew, BIT_LEN, ALPHA_COUNTING_SAMPLE, in_alpha, in_alpha_i, rew_lst=REW_LST)
        
        for sample_id in range(SAMPLE):
            delay = get_monte_MP_delay(sample_id, path_lst, alpha, TEMP, AGE_TIME)
            res.append(delay)
        log.println(f"- [{len(REW_LST)}] ALPHA[{in_alpha_i}] DONE")

    log.println(f"REW LEN: {len(REW_LST)}")
    log.println(f"[{len(REW_LST)}] min {min(res)}, max {max(res)}, average {sum(res)/len(res)}")
    if DUMP_RAW:
        log.println(f"raw result: \n{res}")

    _sample_per_delay = [0 for _ in range(2000)]
    for delay in res:
        _sample_per_delay[int(delay)] += 1
    log.println(f"[{len(REW_LST)}] _sample_per_delay:\n{_sample_per_delay}")


"""error rate of the samples using real alpha"""
if True and (__name__ == "__main__"):
    log.println(f"RUNNING: monte carlo bit {BIT_LEN} for error rate")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"config/SAMPLES: {SAMPLE}")
    log.println(f"config/REW_LST [{len(REW_LST)}] \n{REW_LST}")
    
    if BIT_LEN < 10:
        alpha_notamper = get_alpha(Wallace_rew, BIT_LEN, log=False, rew_lst=[])
        alpha = get_alpha(Wallace_rew, BIT_LEN, log=False, rew_lst=REW_LST)
    else:
        alpha_notamper = get_alpha_sample(Wallace_rew, BIT_LEN, [], ALPHA_COUNTING_SAMPLE, rnd_seed=7, log=False)
        alpha = get_alpha_sample(Wallace_rew, BIT_LEN, REW_LST, ALPHA_COUNTING_SAMPLE, rnd_seed=7, log=False)
    margin_t_sec = 199 *7 *24*60*60
    margin_ps = get_MP_delay(create_crit(0), alpha_notamper, TEMP, margin_t_sec)
    log.println(f"max_ps_delay: {margin_ps}")
    
    def RUN(age_time):
        res = []
        for sample_id in range(SAMPLE):
            age_time_sec = age_time * 7*24*60*60
            
            # vth_matrix = generate_guassian_vth_base(BIT_LEN, seed=seed_generator(sample_id))
            vth_matrix = generate_guassian_vth_base(BIT_LEN, 0, 0)
            error_rate, max_seen_delay = get_monte_error_rate_sample(BIT_LEN, vth_matrix, alpha, TEMP, age_time_sec, margin_ps, ALPHA_COUNTING_SAMPLE, seed_generator(sample_id))
            
            res.append(error_rate)
            log.println(f"age_time [{age_time:3}], max_seen_delay: {max_seen_delay:.4f} [{(max_seen_delay-margin_ps)/margin_ps*100:7.2f}%]")
        return sum(i for i in res) / len(res)
            
    # for age_time in range(200):
    for age_time in [199]:
        error_rate = RUN(age_time)
        log.println(f"week [{age_time:3}]: error rate: {error_rate:.4f}")
 
