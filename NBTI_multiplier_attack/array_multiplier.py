

"""
BIT_LEN = 8 critical path priority:
path [0] -> delay(1 year): 660.7885 -> 755.76
[(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (6, 0, 'C', 'A', 'B', 0.19815220034038428), (5, 0, 'C', 'A', 'B', 0.19582149115085073), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (3, 0, 'C', 'A', 'B', 0.186381280548639), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 1, 'B', 'A', 'C', 0.0979107455754254), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [1] -> delay(1 year): 664.1172 -> 770.0858000000001
[(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (5, 2, 'A', 'C', 'B', 0.24158471457196307), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 1, 'B', 'A', 'C', 0.0979107455754254), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [2] -> delay(1 year): 667.6136999999999 -> 764.3145
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (5, 2, 'A', 'C', 'B', 0.24158471457196307), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (5, 3, 'A', 'C', 'B', 0.21565347887690034), (4, 3, 'A', 'C', 'B', 0.20973448359700508), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [3] -> delay(1 year): 671.3678 -> 764.4481000000001
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (5, 3, 'A', 'C', 'B', 0.21565347887690034), (4, 3, 'A', 'C', 'B', 0.20973448359700508), (5, 4, 'A', 'C', 'B', 0.20495988329686377), (4, 4, 'A', 'C', 'B', 0.19672275459644367), (3, 4, 'A', 'C', 'B', 0.18889224242729097), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [4] -> delay(1 year): 675.9874 -> 766.4697
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (5, 4, 'A', 'C', 'B', 0.20495988329686377), (5, 5, 'A', 'C', 'B', 0.1982989176454809), (4, 4, 'A', 'C', 'B', 0.19672275459644367), (4, 5, 'A', 'C', 'B', 0.1912564870008468), (3, 4, 'A', 'C', 'B', 0.18889224242729097), (3, 5, 'A', 'C', 'B', 0.17956521374615392), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (2, 5, 'A', 'C', 'B', 0.1530815359278554), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [5] -> delay(1 year): 682.9073 -> 768.9422
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (5, 5, 'A', 'C', 'B', 0.1982989176454809), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 5, 'A', 'C', 'B', 0.1912564870008468), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 5, 'A', 'C', 'B', 0.17956521374615392), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (2, 5, 'A', 'C', 'B', 0.1530815359278554), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [6] -> delay(1 year): 700.6959999999999 -> 774.9487999999999
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 7, 'A', 'B', 'C', 0)]

BIT_LEN = 6 critical path priority:
path [0] -> delay(1 year): 467.9429 -> 528.8929
[(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (3, 0, 'C', 'A', 'B', 0.186381280548639), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 1, 'B', 'A', 'C', 0.09319902412032471), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [1] -> delay(1 year): 471.2486 -> 540.2057
[(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.22238989914233254), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 1, 'B', 'A', 'C', 0.09319902412032471), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [2] -> delay(1 year): 475.2501 -> 538.3345
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (3, 2, 'A', 'C', 'B', 0.22238989914233254), (3, 3, 'A', 'C', 'B', 0.19627421883514878), (2, 3, 'A', 'C', 'B', 0.17193910263125894), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [3] -> delay(1 year): 481.0490 -> 538.8727
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.19627421883514878), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (2, 3, 'A', 'C', 'B', 0.17193910263125894), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (1, 4, 'A', 'C', 'B', 0.09658243544414136), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
path [4] -> delay(1 year): 493.9417 -> 541.5005
[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (0, 5, 'B', 'C', 'A', 0.103645377172287), (1, 4, 'A', 'C', 'B', 0.09658243544414136), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 5, 'A', 'B', 'C', 0)]


BIT_LEN = 10 critical path priority:

"""

from tool.log import Log
from tool import NBTI_formula as BTI
from msimulator.bin_func import signed_b,reverse_signed_b
from msimulator.Multiplier import MPn_rew
from alpha import AlphaMultiprocess

from mapping_tgate_pb_delay import tgate_pb_to_delay
from mapping_pmos_vth_body import pmos_vth_to_body

from propagation_delay import array_multiplier_error_rate

import matplotlib.pyplot as plt
from datetime import datetime

BIT_LEN = 6
TEMP = 273.15 + 80
ALPHA_VERIFICATION = False
# log = Log(f"{__file__}.{BIT_LEN}.log", terminal=True)
log = Log(f"{__file__}.{BIT_LEN}.log", terminal=True)

########################################################################################
################## Critical Path
########################################################################################

"""range(bit_len-1)"""
def create_crit(i_th) -> list:
    crit = []
    for lay in range(1, BIT_LEN-2):
        crit += [(lay, i_th), (lay, i_th + 1)]
    crit += [(0, i) for i in range(0, i_th + 2)]
    crit += [(BIT_LEN-2, i) for i in range(i_th, BIT_LEN)]
    return crit

"""for multiplier propagation delay and optimization"""
"""all FA in first row + last 2 FA in each row """
CRITICAL_FA_lst = create_crit(BIT_LEN - 2)
log.println(f"Critical eFA list: {CRITICAL_FA_lst}")


########################################################################################
################## Functions
########################################################################################

def get_alpha(raw_mp, bit_len, log=False, rew_lst=[], verify=False):
    return AlphaMultiprocess(raw_mp, bit_len, log=log, rew_lst=rew_lst).run()

def get_FA_delay(fa_alpha, temp, sec):
    tg1_alpha = max(fa_alpha[0], fa_alpha[1])
    tg1_vth = abs(BTI.Vth) + BTI.delta_vth(BTI.Vdef, temp, tg1_alpha, BTI.Tclk, sec)
    tg1_pb = pmos_vth_to_body(tg1_vth)

    tg2_alpha = max(fa_alpha[2], fa_alpha[3])
    tg2_vth = abs(BTI.Vth) + BTI.delta_vth(BTI.Vdef, temp, tg2_alpha, BTI.Tclk, sec)
    tg2_pb = pmos_vth_to_body(tg2_vth)

    return tgate_pb_to_delay(tg1_pb) + tgate_pb_to_delay(tg2_pb)

def get_MP_delay(critical_fa_lst, alpha, temp, sec):
    ps = 0
    for fa_lay, fa_i in critical_fa_lst:
        ps += get_FA_delay(alpha[fa_lay][fa_i], temp, sec)
    return ps


def get_best_worst_wire_comb(
        log = log,
        bitlen = BIT_LEN,
        temp = TEMP,
        mp = MPn_rew,
        critical_fa_lst = CRITICAL_FA_lst,
):
    # default wiring in multiplier
    best_wiring = [fa + ('A', 'B', 'C', 0) for fa in critical_fa_lst]
    worst_wiring = [fa + ('A', 'B', 'C', 0) for fa in critical_fa_lst]

    default_alpha = get_alpha(mp, bitlen, log=False, rew_lst=[])
    if log:
        log.println(f"\n{default_alpha}")
        log.println(f"default alpha done")


    # iterate in Critical FA list, and log the worst wiring for each
    for fa_index, fa in enumerate(critical_fa_lst):
        wire_combination = [
            ('A', 'B', 'C'),
            ('A', 'C', 'B'),
            ('B', 'A', 'C'),
            ('B', 'C', 'A'),
            ('C', 'A', 'B'),
            ('C', 'B', 'A'),
        ]
        lay, i = fa
        FA_zero_delay = get_FA_delay(default_alpha[lay][i], temp, 0)

        aging_period = 12*30 *24*60*60
        fa_default_delay = get_FA_delay(default_alpha[lay][i], temp, aging_period)
        fa_default_aging_rate = (fa_default_delay - FA_zero_delay) / FA_zero_delay
        if log:
            log.println(f"default wiring, delay rate: {fa_default_aging_rate * 100 :.2f}% [t:{aging_period}s]")
        
        _worst_rate = fa_default_aging_rate
        _best_rate = fa_default_aging_rate
        for comb in wire_combination[1:]:
            rewire = fa + comb
            rewire_alpha = get_alpha(mp, bitlen, log=False, rew_lst=[rewire])

            fa_delay = get_FA_delay(rewire_alpha[lay][i], temp, aging_period)
            fa_aging_rate = (fa_delay - FA_zero_delay) / FA_zero_delay
            if log:
                log.println(f"{rewire}, delay rate: {fa_aging_rate * 100 :.2f}% [t:{aging_period}s]")

            if fa_aging_rate > _worst_rate:
                _worst_rate = fa_aging_rate
                worst_wiring[fa_index] = fa + comb + (fa_aging_rate - fa_default_aging_rate, )
                if log:
                    log.println(f"-new worst")
            if fa_aging_rate < _best_rate:
                _best_rate = fa_aging_rate
                best_wiring[fa_index] = fa + comb + (fa_aging_rate - fa_default_aging_rate, )
                if log:
                    log.println(f"-new best")
            
        if log:
            log.println()
    
    if log:
        log.println(f"best wiring combination: \n{best_wiring}")
        log.println(f"worst wiring combination: \n{worst_wiring}")

    return (best_wiring, worst_wiring)


"""
wire combination notation:

(0, 0, 'C', 'B', 'A', 0.50)
- FA index
- FA wiring combination
- difference of aging_rate and default_aging_rate
"""
def examine_wire_comb(
        wire_comb,
        bit_len = BIT_LEN, 
        temp = TEMP, 
        log = log, 
        plot = "RATE" or "DELAY", 
        plot_save_clear = True,
        plot_label = "",
        alpha_verification = ALPHA_VERIFICATION, 
        critical_fa_lst = CRITICAL_FA_lst, 
        mp = MPn_rew,
    ): 
    if log:   
        log.println(f"aging log for following wire comb \n{wire_comb}")
    
    alpha = get_alpha(mp, bit_len, log=False, rew_lst=wire_comb, verify=alpha_verification)
    if log:
        log.println(f"alpha: \n{alpha}")
    _mp_zero_delay = get_MP_delay(critical_fa_lst, alpha, temp, 0)
    
    res_week = []
    res_delay = []

    for week in range(0, 200):
        delay = get_MP_delay(critical_fa_lst, alpha, temp, week * 7 *24*60*60)
        aging_rate = (delay - _mp_zero_delay) / _mp_zero_delay
        if log:
            log.println(f"week {week:03}: {delay: 8.2f} [{aging_rate * 100 :4.2f}%]")
        
        if plot:
            res_week.append(week)

            if plot == "DELAY":
                res_delay.append(delay)
            elif plot == "RATE" or True:
                res_delay.append(aging_rate)

    
    if plot:
        plt.plot(res_week, res_delay, label=plot_label)
        plt.title(f"ArrayMultiplier-BIT-{bit_len}-TEMP-{temp}")

        if plot_save_clear:
            timestamp = datetime.now().strftime('%m,%d-%H:%M:%S.%f')
            fig_name = f"fig-{timestamp}.jpg"
            plt.legend()
            plt.savefig(fig_name)
            plt.clf()
            if log:
                log.println(f"plot saved in {fig_name}")



def examine_multi_wire_comb(
        multi_wire_comb,
        plot_labels,
        log = log, 
        plot = True,
    ): 

    for i_sub_wc, sub_wc in enumerate(multi_wire_comb):
        examine_wire_comb(
            sub_wc,
            log = log, 
            plot = plot, 
            plot_save_clear = True if i_sub_wc==len(multi_wire_comb)-1 else False,
            plot_label = plot_labels[i_sub_wc],
        )


def sort_rewiring(wiring):
    return sorted(wiring, key=lambda x: x[-1], reverse=True)


########################################################################################
################## MAIN
########################################################################################


"""get critical path priorities"""
if False and (__name__ == "__main__"):
    """each path gets full rewiring -> aging(1 year) -> route with higher aging higher priority"""
    log.println("RUNNING: critical path priorities")
    for i in range(BIT_LEN - 1):
        critical_path = create_crit(i)
        _, worst_wiring = get_best_worst_wire_comb(
            log=False,
            bitlen=BIT_LEN,
            critical_fa_lst=critical_path,
            mp=MPn_rew,
        )

        alpha_nomitigation = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=[])
        alpha_rewired = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=worst_wiring)
        delay_nomitigation = get_MP_delay(critical_path, alpha_nomitigation, TEMP, 50 * 7 *24*60*60)
        delay_rewired = get_MP_delay(critical_path, alpha_rewired, TEMP, 50 * 7 *24*60*60)

        log.println(f"path [{i}] -> delay(1 year): {delay_nomitigation:.4f} -> {delay_rewired:.4f}")
        log.println(f"{sort_rewiring(worst_wiring)}")
    


"""specific wire combination aging"""
if True and (__name__ == "__main__"):
    # normal aging without mitigation

    REW_LST = []
    
    if True:
        if BIT_LEN == 6:
            """6-bit critical-path"""
            REW_LST = [(1, 4, 'A', 'C', 'B', 0.09658243544414136), (1, 5, 'A', 'B', 'C', 0), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'B', 'C', 'A', 0.103645377172287), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 5, 'B', 'A', 'C', 0.07976750715539899)]
        elif BIT_LEN == 8:
            """8-bit critical-path"""
            REW_LST = [(0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (1, 7, 'A', 'B', 'C', 0), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803)]
        elif BIT_LEN == 10:
            """10-bit critical-path"""
            REW_LST = [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (7, 9, 'A', 'C', 'B', 0.18074349099655923), (6, 9, 'A', 'C', 'B', 0.17443249200648703), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (5, 9, 'A', 'C', 'B', 0.16337776734791393), (4, 9, 'A', 'C', 'B', 0.1458318491729908), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (3, 9, 'A', 'C', 'B', 0.11787204450625888), (0, 9, 'B', 'A', 'C', 0.10020910946188893), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (2, 9, 'A', 'C', 'B', 0.06400288218241534), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 9, 'A', 'B', 'C', 0)]
        else:
            raise RuntimeError("invalid BIT_LEN")
        
    #rewire top-10% of circuit
    circuit_size = (BIT_LEN - 1) * (BIT_LEN)
    REW_LST = sort_rewiring(REW_LST)
    REW_LST = REW_LST[:(circuit_size//10)]
    
    examine_wire_comb(
        wire_comb = REW_LST,
        bit_len=BIT_LEN, 
        temp=TEMP, 
        log=log, 
        plot=True, 
        alpha_verification=ALPHA_VERIFICATION,
        critical_fa_lst=CRITICAL_FA_lst
        )
    

"""
extracting best and worst wiring combination for the provided multiplier (6, 8, 10 bits)
"""
if False and (__name__ == "__main__"):
    best_wiring, worst_wiring = get_best_worst_wire_comb(log=False)
    log.println(f"worst wiring:\n{worst_wiring}")
    
    examine_multi_wire_comb(
        [worst_wiring, [], best_wiring],
        ["attack", "no-mitigation", "optimization"],
        log=log,
        plot="DELAY",
    )


"""
partial rewiring
"""
if False and (__name__ == "__main__"):
    _, worst_wiring = get_best_worst_wire_comb(log=False)
    worst_wiring = sorted(worst_wiring, key=lambda x: x[-1], reverse=True)

    full_combo = []
    full_combo_label = []
    # for combo in range(0, len(worst_wiring)+1, 4):
    for combo in [0, len(worst_wiring)//4, len(worst_wiring)//2, len(worst_wiring)*3//4, len(worst_wiring)]:
        full_combo.append(worst_wiring[0:combo])
        full_combo_label.append(f"{combo} / {len(worst_wiring)}")
    log.println(f"wire combo:\n{full_combo}")
    
    examine_multi_wire_comb(
        multi_wire_comb = full_combo,
        plot_labels = full_combo_label,
        log = log,
        plot = "DELAY"
    )



"""
rewiring list for all the FAs (sorted)
"""
if False and (__name__ == "__main__"):
    lst = []
    for fa_i in range(BIT_LEN - 1):
        for fa_j in range(BIT_LEN):
            lst += [(fa_i, fa_j)]

    best_wiring, worst_wiring = get_best_worst_wire_comb(critical_fa_lst=lst, log=False)
    log.println(f"worst complete wiring:\n{worst_wiring}")
    worst_wiring = sorted(worst_wiring, key=lambda x: x[-1], reverse=True)
    log.println(f"worst complete wiring (sorted):\n{worst_wiring}")


"""
error rate of wire combination
"""
if False and __name__ == "__main__":
    
    # REW_LST = []
    """6-bit M-1-100%"""
    # REW_LST = [(1, 4, 'A', 'C', 'B', 0.09658243544414136), (1, 5, 'A', 'B', 'C', 0), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'B', 'C', 'A', 0.103645377172287), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 5, 'B', 'A', 'C', 0.07976750715539899)]
    """8-bit M-1-100%"""
    # REW_LST = [(0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (1, 7, 'A', 'B', 'C', 0), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803)]
    """10-bit M-1-100%"""
    # REW_LST = [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (7, 9, 'A', 'C', 'B', 0.18074349099655923), (6, 9, 'A', 'C', 'B', 0.17443249200648703), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (5, 9, 'A', 'C', 'B', 0.16337776734791393), (4, 9, 'A', 'C', 'B', 0.1458318491729908), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (3, 9, 'A', 'C', 'B', 0.11787204450625888), (0, 9, 'B', 'A', 'C', 0.10020910946188893), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (2, 9, 'A', 'C', 'B', 0.06400288218241534), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 9, 'A', 'B', 'C', 0)]

    """6-bit M-All-100%"""
    # REW_LST =[(0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 5, 'A', 'B', 'C', 0), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (2, 3, 'A', 'C', 'B', 0.17193910263125894), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (4, 1, 'B', 'A', 'C', 0.09319902412032471), (3, 0, 'C', 'A', 'B', 0.186381280548639), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (1, 1, 'A', 'C', 'B', 0.34500546869434406), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 2, 'A', 'C', 'B', 0.22238989914233254), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (0, 5, 'B', 'C', 'A', 0.103645377172287), (1, 4, 'A', 'C', 'B', 0.09658243544414136), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (3, 3, 'A', 'C', 'B', 0.19627421883514878), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (0, 3, 'A', 'C', 'B', 0.25481341220235604)]
    """8-bit M-All-100%"""
    # REW_LST = [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (5, 2, 'A', 'C', 'B', 0.24158471457196307), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (5, 3, 'A', 'C', 'B', 0.21565347887690034), (4, 3, 'A', 'C', 'B', 0.20973448359700508), (5, 4, 'A', 'C', 'B', 0.20495988329686377), (5, 5, 'A', 'C', 'B', 0.1982989176454809), (6, 0, 'C', 'A', 'B', 0.19815220034038428), (4, 4, 'A', 'C', 'B', 0.19672275459644367), (5, 0, 'C', 'A', 'B', 0.19582149115085073), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (4, 5, 'A', 'C', 'B', 0.1912564870008468), (3, 4, 'A', 'C', 'B', 0.18889224242729097), (3, 0, 'C', 'A', 'B', 0.186381280548639), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 5, 'A', 'C', 'B', 0.17956521374615392), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (2, 5, 'A', 'C', 'B', 0.1530815359278554), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (6, 1, 'B', 'A', 'C', 0.0979107455754254), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 7, 'A', 'B', 'C', 0)]
    """10-bit M-All-100%"""
    # REW_LST = [(5, 1, 'A', 'C', 'B', 0.32992949185509374), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (7, 6, 'A', 'C', 'B', 0.19800967495829058), (7, 5, 'A', 'C', 'B', 0.2015602337416268), (2, 9, 'A', 'C', 'B', 0.06400288218241534), (1, 6, 'A', 'C', 'B', 0.22088915522291758), (1, 1, 'A', 'C', 'B', 0.34500546869434406), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (6, 9, 'A', 'C', 'B', 0.17443249200648703), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (4, 7, 'A', 'C', 'B', 0.18775203937054102), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (5, 6, 'A', 'C', 'B', 0.1962113399901072), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (4, 3, 'A', 'C', 'B', 0.2232450514348956), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (7, 2, 'A', 'C', 'B', 0.24809057907224374), (6, 3, 'A', 'C', 'B', 0.21857105728681986), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (6, 5, 'A', 'C', 'B', 0.2003864953008545), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (6, 1, 'A', 'C', 'B', 0.33022711838828966), (4, 4, 'A', 'C', 'B', 0.21258079931587837), (1, 7, 'A', 'C', 'B', 0.2190578759674981), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (7, 9, 'A', 'C', 'B', 0.18074349099655923), (3, 6, 'A', 'C', 'B', 0.18021076988857865), (7, 4, 'A', 'C', 'B', 0.20796968401284427), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (7, 3, 'A', 'C', 'B', 0.2209017664763534), (5, 7, 'A', 'C', 'B', 0.19480285386118035), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (8, 2, 'C', 'A', 'B', 0.139972500985102), (6, 0, 'C', 'A', 'B', 0.19815220034038428), (1, 9, 'A', 'B', 'C', 0), (2, 7, 'A', 'C', 'B', 0.15378555175144876), (8, 0, 'C', 'A', 'B', 0.20048290952991782), (8, 1, 'B', 'A', 'C', 0.10024145476495894), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (6, 6, 'A', 'C', 'B', 0.1985755845636627), (5, 9, 'A', 'C', 'B', 0.16337776734791393), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 3, 'C', 'A', 'B', 0.16370297710371695), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 4, 'A', 'C', 'B', 0.21775363230128197), (5, 2, 'A', 'C', 'B', 0.2493104286660463), (4, 6, 'A', 'C', 'B', 0.19091274931462082), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (7, 7, 'A', 'C', 'B', 0.1990031607099439), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (5, 4, 'A', 'C', 'B', 0.2038741752391493), (7, 0, 'C', 'A', 'B', 0.20048290952991782), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (5, 5, 'A', 'C', 'B', 0.19977028261944907), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (5, 0, 'C', 'A', 'B', 0.19582149115085073), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (7, 1, 'A', 'C', 'B', 0.3325578275778232), (3, 0, 'C', 'A', 'B', 0.186381280548639), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (6, 2, 'A', 'C', 'B', 0.24809057907224374), (0, 9, 'B', 'A', 'C', 0.10020910946188893), (4, 5, 'A', 'C', 'B', 0.19220805352247294), (3, 7, 'A', 'C', 'B', 0.1760607661158478), (3, 9, 'A', 'C', 'B', 0.11787204450625888), (3, 5, 'A', 'C', 'B', 0.21069443396463705), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (2, 5, 'A', 'C', 'B', 0.21515883196257457), (2, 6, 'A', 'C', 'B', 0.21336888084039685), (6, 7, 'A', 'C', 'B', 0.19608139037702182), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (6, 4, 'A', 'C', 'B', 0.2067959455720717), (5, 3, 'A', 'C', 'B', 0.22207550491712597), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (4, 9, 'A', 'C', 'B', 0.1458318491729908)]

    #rewire top-20% of circuit
    # circuit_size = (BIT_LEN - 1) * (BIT_LEN)
    # REW_LST = REW_LST[:(circuit_size//5)]

    log.println(f"RUNNING: error rate bitlen [{BIT_LEN}], REW_LST [{len(REW_LST)}]: \n{REW_LST}")

    alpha_notamper = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=[], verify=False)
    alpha = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=REW_LST, verify=False)

    res = []
    for t_week in range(200):
        t_sec = t_week *7 *24*60*60
        
        # max_ps_delay = get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, t_sec) * 1.10    #10% absolute margin
        # max_ps_delay = get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, t_sec) + (0.10 * get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, 0))  # 10% raise margin

        # margin_percentage = 0.10 + (-0.10) * (t_week / 199)     # dynamic margin, margin reduces as time goes by (ideal case is always error zero)
        # max_ps_delay = get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, t_sec) + (margin_percentage * get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, 0))

        margin_t_sec = 199 *7 *24*60*60
        max_ps_delay = get_MP_delay(CRITICAL_FA_lst, alpha_notamper, TEMP, margin_t_sec)   # fixed margin

        err_rate, max_seen_delay = array_multiplier_error_rate(BIT_LEN, alpha, TEMP, t_sec, max_ps_delay)
        res.append(err_rate)
        
        log.println(f"REW [{len(REW_LST)}] week [{t_week:03}], error rate: {err_rate:.4f}, max seen delay: {max_seen_delay:.3f}, max_allowed_delay: {max_ps_delay:.3f}")
    log.println(f"REW [{len(REW_LST)}], error rate: \n{res}")

