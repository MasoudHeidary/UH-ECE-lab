

from tool.log import Log
from tool import NBTI_formula as BTI
from msimulator.Multiplier import MPn_rew
from msimulator.bin_func import signed_b
from alpha import AlphaMultiprocess

from mapping_tgate_pb_delay import tgate_pb_to_delay
from mapping_pmos_vth_body import pmos_vth_to_body

import random

BIT_LEN = 8
# SAMPLE = 300_000
SAMPLE = 1

# IN_ALPHA_SAMPLE = 2500
# SAMPLE = SAMPLE // IN_ALPHA_SAMPLE

TEMP = 273.15 + 80
# AGE_TIME = (200-1) * 7 *24*60*60      # 4 year
AGE_TIME = (50) * 7 *24*60*60           # 1 year
# AGE_TIME = 100                        # t=0 basically

########################################################################################
################## Rewiring List
########################################################################################
REW_LST = None
ALPHA_COUNTING_SAMPLE = None

if BIT_LEN == 8:
    ALPHA_COUNTING_SAMPLE = 40_000

    """no-mitigation"""
    # REW_LST = []

    """half-critical path"""
    # REW_LST = [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (5, 7, 'A', 'C', 'B', 0.16337776734791393)]

    """one critical-path"""
    REW_LST = [(0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (1, 7, 'A', 'B', 'C', 0), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 7, 'B', 'A', 'C', 0.09435069207269803)]

    """two ciritcal-path"""
    # REW_LST = \
    # list(set(
        # [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 7, 'A', 'B', 'C', 0)] +\
        # [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (5, 2, 'A', 'C', 'B', 0.24158471457196307), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (6, 1, 'B', 'A', 'C', 0.0979107455754254), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]
    # ))

    """full circuit tampering"""
    # REW_LST = [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (5, 2, 'A', 'C', 'B', 0.24158471457196307), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (5, 3, 'A', 'C', 'B', 0.21565347887690034), (4, 3, 'A', 'C', 'B', 0.20973448359700508), (5, 4, 'A', 'C', 'B', 0.20495988329686377), (5, 5, 'A', 'C', 'B', 0.1982989176454809), (6, 0, 'C', 'A', 'B', 0.19815220034038428), (4, 4, 'A', 'C', 'B', 0.19672275459644367), (5, 0, 'C', 'A', 'B', 0.19582149115085073), (5, 6, 'A', 'C', 'B', 0.19532684423652524), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (4, 5, 'A', 'C', 'B', 0.1912564870008468), (3, 4, 'A', 'C', 'B', 0.18889224242729097), (3, 0, 'C', 'A', 'B', 0.186381280548639), (4, 6, 'A', 'C', 'B', 0.18361880328982083), (3, 5, 'A', 'C', 'B', 0.17956521374615392), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (3, 6, 'A', 'C', 'B', 0.17180177234504546), (5, 7, 'A', 'C', 'B', 0.16337776734791393), (6, 4, 'C', 'A', 'B', 0.16147706598925166), (6, 3, 'C', 'A', 'B', 0.15606110146968832), (2, 5, 'A', 'C', 'B', 0.1530815359278554), (6, 5, 'C', 'A', 'B', 0.1495342773543939), (4, 7, 'A', 'C', 'B', 0.14765893785803158), (2, 6, 'A', 'C', 'B', 0.1469926371678449), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (6, 2, 'C', 'A', 'B', 0.1327288580363356), (6, 6, 'C', 'A', 'B', 0.1222909697594673), (3, 7, 'A', 'C', 'B', 0.11787204450625888), (0, 7, 'B', 'A', 'C', 0.10020910946188893), (6, 1, 'B', 'A', 'C', 0.0979107455754254), (6, 7, 'B', 'A', 'C', 0.09435069207269803), (1, 6, 'A', 'C', 'B', 0.08965346783517958), (2, 7, 'A', 'C', 'B', 0.06554451463712985), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 7, 'A', 'B', 'C', 0)]

elif BIT_LEN == 6:
    ALPHA_COUNTING_SAMPLE = 2_000

    """no-mitigation"""
    # REW_LST = []

    """full critical-path"""
    # REW_LST = [(1, 4, 'A', 'C', 'B', 0.09658243544414136), (1, 5, 'A', 'B', 'C', 0), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'B', 'C', 'A', 0.103645377172287), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 5, 'B', 'A', 'C', 0.07976750715539899)]

    """full circuit"""
    # REW_LST = \
    # list(set(
    #     [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (3, 0, 'C', 'A', 'B', 0.186381280548639), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 1, 'B', 'A', 'C', 0.09319902412032471), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]       +\
    #     [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.22238989914233254), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 1, 'B', 'A', 'C', 0.09319902412032471), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]      +\
    #     [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (3, 2, 'A', 'C', 'B', 0.22238989914233254), (3, 3, 'A', 'C', 'B', 0.19627421883514878), (2, 3, 'A', 'C', 'B', 0.17193910263125894), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 2, 'C', 'A', 'B', 0.11970036134376283), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]     +\
    #     [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.19627421883514878), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (2, 3, 'A', 'C', 'B', 0.17193910263125894), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (4, 3, 'C', 'A', 'B', 0.12822254080837064), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (1, 4, 'A', 'C', 'B', 0.09658243544414136), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]      +\
    #     [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 4, 'A', 'C', 'B', 0.18241572138802975), (2, 4, 'A', 'C', 'B', 0.1496285059359429), (3, 5, 'A', 'C', 'B', 0.12469209243091955), (4, 4, 'C', 'A', 'B', 0.10590474274168515), (0, 5, 'B', 'C', 'A', 0.103645377172287), (1, 4, 'A', 'C', 'B', 0.09658243544414136), (4, 5, 'B', 'A', 'C', 0.07976750715539899), (2, 5, 'A', 'C', 'B', 0.06917656718668863), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 5, 'A', 'B', 'C', 0)]
    # ))

elif BIT_LEN == 10:
    ALPHA_COUNTING_SAMPLE = 100_000

    """no-mitigation"""
    # REW_LST = []
    
    """full critical-path"""
    # REW_LST = [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (7, 9, 'A', 'C', 'B', 0.18074349099655923), (6, 9, 'A', 'C', 'B', 0.17443249200648703), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (5, 9, 'A', 'C', 'B', 0.16337776734791393), (4, 9, 'A', 'C', 'B', 0.1458318491729908), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (3, 9, 'A', 'C', 'B', 0.11787204450625888), (0, 9, 'B', 'A', 'C', 0.10020910946188893), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (2, 9, 'A', 'C', 'B', 0.06400288218241534), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 9, 'A', 'B', 'C', 0)]
    
    
    """full circuit"""
    # REW_LST = \
    #     list(set(
    #         [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (7, 1, 'A', 'C', 'B', 0.3325578275778232), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (6, 1, 'A', 'C', 'B', 0.33022711838828966), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (7, 0, 'C', 'A', 'B', 0.20048290952991782), (8, 0, 'C', 'A', 'B', 0.20048290952991782), (6, 0, 'C', 'A', 'B', 0.19815220034038428), (5, 0, 'C', 'A', 'B', 0.19582149115085073), (4, 0, 'C', 'A', 'B', 0.19347401426930622), (3, 0, 'C', 'A', 'B', 0.186381280548639), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (2, 0, 'C', 'A', 'B', 0.17317253116694764), (8, 3, 'C', 'A', 'B', 0.16370297710371695), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (1, 0, 'C', 'A', 'B', 0.14281882907082505), (8, 2, 'C', 'A', 'B', 0.139972500985102), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 1, 'B', 'A', 'C', 0.10024145476495894), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]        +\
    #         [(1, 1, 'A', 'C', 'B', 0.34500546869434406), (2, 1, 'A', 'C', 'B', 0.3426813216294845), (3, 1, 'A', 'C', 'B', 0.33285964603402163), (7, 1, 'A', 'C', 'B', 0.3325578275778232), (4, 1, 'A', 'C', 'B', 0.3313295941380153), (6, 1, 'A', 'C', 'B', 0.33022711838828966), (5, 1, 'A', 'C', 'B', 0.32992949185509374), (0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (5, 2, 'A', 'C', 'B', 0.2493104286660463), (6, 2, 'A', 'C', 'B', 0.24809057907224374), (7, 2, 'A', 'C', 'B', 0.24809057907224374), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (8, 3, 'C', 'A', 'B', 0.16370297710371695), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (8, 2, 'C', 'A', 'B', 0.139972500985102), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 1, 'B', 'A', 'C', 0.10024145476495894), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]         +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (1, 2, 'A', 'C', 'B', 0.2835926597969251), (2, 2, 'A', 'C', 'B', 0.26321084534319295), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (3, 2, 'A', 'C', 'B', 0.2559713943174293), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (4, 2, 'A', 'C', 'B', 0.25051770249084093), (5, 2, 'A', 'C', 'B', 0.2493104286660463), (6, 2, 'A', 'C', 'B', 0.24809057907224374), (7, 2, 'A', 'C', 'B', 0.24809057907224374), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (4, 3, 'A', 'C', 'B', 0.2232450514348956), (5, 3, 'A', 'C', 'B', 0.22207550491712597), (7, 3, 'A', 'C', 'B', 0.2209017664763534), (6, 3, 'A', 'C', 'B', 0.21857105728681986), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (8, 3, 'C', 'A', 'B', 0.16370297710371695), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (8, 2, 'C', 'A', 'B', 0.139972500985102), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]        +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (1, 3, 'A', 'C', 'B', 0.24528246539636517), (2, 3, 'A', 'C', 'B', 0.23865036847003196), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (3, 3, 'A', 'C', 'B', 0.22857298557140127), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (4, 3, 'A', 'C', 'B', 0.2232450514348956), (5, 3, 'A', 'C', 'B', 0.22207550491712597), (7, 3, 'A', 'C', 'B', 0.2209017664763534), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (6, 3, 'A', 'C', 'B', 0.21857105728681986), (3, 4, 'A', 'C', 'B', 0.21775363230128197), (4, 4, 'A', 'C', 'B', 0.21258079931587837), (7, 4, 'A', 'C', 'B', 0.20796968401284427), (6, 4, 'A', 'C', 'B', 0.2067959455720717), (5, 4, 'A', 'C', 'B', 0.2038741752391493), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (8, 3, 'C', 'A', 'B', 0.16370297710371695), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]       +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (1, 4, 'A', 'C', 'B', 0.22826455908913784), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (2, 4, 'A', 'C', 'B', 0.2206167157121659), (3, 4, 'A', 'C', 'B', 0.21775363230128197), (2, 5, 'A', 'C', 'B', 0.21515883196257457), (4, 4, 'A', 'C', 'B', 0.21258079931587837), (3, 5, 'A', 'C', 'B', 0.21069443396463705), (7, 4, 'A', 'C', 'B', 0.20796968401284427), (6, 4, 'A', 'C', 'B', 0.2067959455720717), (5, 4, 'A', 'C', 'B', 0.2038741752391493), (7, 5, 'A', 'C', 'B', 0.2015602337416268), (6, 5, 'A', 'C', 'B', 0.2003864953008545), (5, 5, 'A', 'C', 'B', 0.19977028261944907), (4, 5, 'A', 'C', 'B', 0.19220805352247294), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 4, 'C', 'A', 'B', 0.17342823847011607), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]       +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (1, 5, 'A', 'C', 'B', 0.22271624390795836), (1, 6, 'A', 'C', 'B', 0.22088915522291758), (2, 5, 'A', 'C', 'B', 0.21515883196257457), (2, 6, 'A', 'C', 'B', 0.21336888084039685), (3, 5, 'A', 'C', 'B', 0.21069443396463705), (7, 5, 'A', 'C', 'B', 0.2015602337416268), (6, 5, 'A', 'C', 'B', 0.2003864953008545), (5, 5, 'A', 'C', 'B', 0.19977028261944907), (6, 6, 'A', 'C', 'B', 0.1985755845636627), (7, 6, 'A', 'C', 'B', 0.19800967495829058), (5, 6, 'A', 'C', 'B', 0.1962113399901072), (4, 5, 'A', 'C', 'B', 0.19220805352247294), (4, 6, 'A', 'C', 'B', 0.19091274931462082), (3, 6, 'A', 'C', 'B', 0.18021076988857865), (8, 5, 'C', 'A', 'B', 0.1783830914593758), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]      +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (1, 6, 'A', 'C', 'B', 0.22088915522291758), (1, 7, 'A', 'C', 'B', 0.2190578759674981), (2, 6, 'A', 'C', 'B', 0.21336888084039685), (7, 7, 'A', 'C', 'B', 0.1990031607099439), (6, 6, 'A', 'C', 'B', 0.1985755845636627), (7, 6, 'A', 'C', 'B', 0.19800967495829058), (5, 6, 'A', 'C', 'B', 0.1962113399901072), (6, 7, 'A', 'C', 'B', 0.19608139037702182), (5, 7, 'A', 'C', 'B', 0.19480285386118035), (4, 6, 'A', 'C', 'B', 0.19091274931462082), (4, 7, 'A', 'C', 'B', 0.18775203937054102), (3, 6, 'A', 'C', 'B', 0.18021076988857865), (3, 7, 'A', 'C', 'B', 0.1760607661158478), (8, 6, 'C', 'A', 'B', 0.17448879498981373), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (2, 7, 'A', 'C', 'B', 0.15378555175144876), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]      +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (1, 7, 'A', 'C', 'B', 0.2190578759674981), (7, 7, 'A', 'C', 'B', 0.1990031607099439), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (6, 7, 'A', 'C', 'B', 0.19608139037702182), (5, 7, 'A', 'C', 'B', 0.19480285386118035), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 7, 'A', 'C', 'B', 0.18775203937054102), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (3, 7, 'A', 'C', 'B', 0.1760607661158478), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (8, 7, 'C', 'A', 'B', 0.15786362836087442), (2, 7, 'A', 'C', 'B', 0.15378555175144876), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (0, 0, 'C', 'A', 'B', 0.06047137087990345)]    +\
    #         [(0, 1, 'A', 'C', 'B', 0.28976406320693054), (0, 2, 'A', 'C', 'B', 0.26259279119258666), (0, 3, 'A', 'C', 'B', 0.25481341220235604), (0, 4, 'A', 'C', 'B', 0.2315129781993061), (0, 5, 'A', 'C', 'B', 0.22822863079578365), (0, 6, 'A', 'C', 'B', 0.22620104898034382), (0, 7, 'A', 'C', 'B', 0.22416927794627756), (0, 8, 'A', 'C', 'B', 0.22416927794627756), (6, 8, 'A', 'C', 'B', 0.19894028186490276), (7, 8, 'A', 'C', 'B', 0.19787553342220232), (5, 8, 'A', 'C', 'B', 0.19182239660621947), (4, 8, 'A', 'C', 'B', 0.18457036981144698), (7, 9, 'A', 'C', 'B', 0.18074349099655923), (6, 9, 'A', 'C', 'B', 0.17443249200648703), (3, 8, 'A', 'C', 'B', 0.17002858891487882), (5, 9, 'A', 'C', 'B', 0.16337776734791393), (4, 9, 'A', 'C', 'B', 0.1458318491729908), (2, 8, 'A', 'C', 'B', 0.14522002589772504), (8, 8, 'C', 'A', 'B', 0.12582056892778992), (3, 9, 'A', 'C', 'B', 0.11787204450625888), (0, 9, 'B', 'A', 'C', 0.10020910946188893), (8, 9, 'B', 'A', 'C', 0.09787915233142397), (1, 8, 'A', 'C', 'B', 0.08793588819813358), (2, 9, 'A', 'C', 'B', 0.06400288218241534), (0, 0, 'C', 'A', 'B', 0.06047137087990345), (1, 9, 'A', 'B', 'C', 0)]
    #     ))


if REW_LST == None:
    raise RuntimeError("REW_LST is NONE, the defined Bit Length does not have corresponding rewiring")

log = Log(f"{__file__}.{BIT_LEN}.{TEMP}.log", terminal=True)

########################################################################################
################## Critical Path
########################################################################################

path_lst = []

"""auto, all critical path"""
def create_crit(i_th):
    crit = []
    for lay in range(1, BIT_LEN-2):
        crit += [(lay, i_th), (lay, i_th + 1)]
    crit += [(0, i) for i in range(0, i_th + 2)]
    crit += [(BIT_LEN-2, i) for i in range(i_th, BIT_LEN)]
    return crit

for i_th in range(BIT_LEN-1):
    path_lst += [create_crit(i_th)]

log.println(f"[{BIT_LEN}] critical path list: \n{path_lst}")


########################################################################################
################## Functions
########################################################################################

def get_alpha(raw_mp, bit_len, log=False, rew_lst=[], verify=False):
    return AlphaMultiprocess(raw_mp, bit_len, log=log, rew_lst=rew_lst).run()

def get_monte_alpha(raw_mp, bit_len, sample_count, in_alpha, seed, log=False, rew_lst=[], verify=False):
    
    # alpah structure as counter
    alpha_row = bit_len - 1
    alpha_index = bit_len
    alpha = [
        [
            [0 for _ in range(6)]
            for _ in range(alpha_index)
        ]
        for _ in range(alpha_row)
    ]

    # counting alpha
    random.seed(seed)
    for alpha_sample_i in range(sample_count):
        a_bin = [
            random.choices([0,1], weights=[in_alpha['A'][bit], 1-in_alpha['A'][bit]], k=1)[0]
            for bit in range(bit_len)
        ]
        b_bin = [
            random.choices([0,1], weights=[in_alpha['B'][bit], 1-in_alpha['B'][bit]], k=1)[0]
            for bit in range(bit_len)
        ]

        mp = raw_mp(a_bin, b_bin, bit_len, rew_lst)
        mp.output

        #TODO: verify

        for row in range(alpha_row):
            for index in range(alpha_index):
                for t in range(6):
                    alpha[row][index][t] += (not mp.gfa[row][index].p[t])

    
    # alpha counter -> alpha probability
    for row in range(alpha_row):
        for index in range(alpha_index):
            for t in range(6):
                alpha[row][index][t] /= sample_count
    return alpha

def seed_generator(sample_index):
    return 7*sample_index + 1

def generate_guassian_vth_base(bit_len, mu=0, sigma=0.05, base_vth=abs(BTI.Vth), seed=False):
    if seed:
        random.seed(seed)

    vth = [
        [[base_vth for _ in range(6)] for _ in range(bit_len)] for _ in range(bit_len-1)
    ]

    for fa_i in range(bit_len-1):
        for fa_j in range(bit_len):
            for t_index in range(6):
                vth_variation = random.gauss(mu, sigma)
                vth[fa_i][fa_j][t_index] *= (1 + vth_variation)

    return vth

def get_monte_FA_delay(fa_vth, fa_alpha, temp, sec):
    tg1_vth_1 = fa_vth[0] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[0], BTI.Tclk, sec)
    tg1_vth_2 = fa_vth[1] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[1], BTI.Tclk, sec)
    tg1_vth = max(tg1_vth_1, tg1_vth_2)
    tg1_pb = pmos_vth_to_body(tg1_vth)

    tg2_vth_1 = fa_vth[2] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[2], BTI.Tclk, sec)
    tg2_vth_2 = fa_vth[3] + BTI.delta_vth(BTI.Vdef, temp, fa_alpha[3], BTI.Tclk, sec)
    tg2_vth = max(tg2_vth_1, tg2_vth_2)
    tg2_pb = pmos_vth_to_body(tg2_vth)

    # //fa_vth[4] fa_vth[5] ignored
    return tgate_pb_to_delay(tg1_pb) + tgate_pb_to_delay(tg2_pb)

def get_monte_FA_delay_matrix(bitlen, vth, alpha, temp, sec):
    fa_delay = [
        [get_monte_FA_delay(vth[fa_i][fa_j], alpha[fa_i][fa_j], temp, sec) for fa_j in range(bitlen)]
        for fa_i in range(bitlen - 1)
    ]
    return fa_delay

def get_monte_path_delay(vth_matrix, critical_fa_lst, alpha, temp, sec):
    ps = 0
    for fa_lay, fa_i in critical_fa_lst:
        ps += get_monte_FA_delay(vth_matrix[fa_lay][fa_i], alpha[fa_lay][fa_i], temp, sec)
    return ps

def get_monte_MP_delay(sample_id, path_lst, alpha, temp, sec):
    ps = 0
    vth_matrix = generate_guassian_vth_base(BIT_LEN, seed=seed_generator(sample_id))
    for path in path_lst:
        path_delay = get_monte_path_delay(vth_matrix, path, alpha, temp, sec)
        ps = max(ps, path_delay)
    return ps


"""get multiplier propagation delay for a specific input"""
def get_monte_pd(A, B, bitlen, fa_delay):
    # same function method, only the fa_delay is dependent on Vth matrix
    layer = bitlen-1
    index = bitlen
    mp = MPn_rew(signed_b(A, bitlen), signed_b(B, bitlen), bitlen, rew_lst=[])
    mp.output
    
    ps_matrix = [
        [0 for _ in range(index)]
        for _ in range(layer)
    ]
    
    for fa_i in range(layer):
        for fa_j in range(index):
            if mp.gfa[fa_i][fa_j].sum or mp.gfa[fa_i][fa_j].carry:
                previous_block = 0

                # gate at top
                i, j = fa_i-1, fa_j+1
                if i >= 0 and j < bitlen and mp.gfa[i][j].sum:
                    d = ps_matrix[i][j]
                    previous_block = max(previous_block, d)

                # gate at right side
                i, j = fa_i, fa_j-1
                if j >= 0 and mp.gfa[i][j].carry:
                    d = ps_matrix[i][j]
                    previous_block = max(previous_block, d)

                ps_matrix[fa_i][fa_j] = fa_delay[fa_i][fa_j] + previous_block
    # if max(ps_matrix[-1]) > 761:
    #     pass
    return max(ps_matrix[-1])

def get_monte_error_rate(bitlen, vth, alpha, temp, sec, max_ps_delay):
    limit = 2 ** (bitlen - 1)
    length = 2*limit

    error_counter = 0
    fa_delay = get_monte_FA_delay_matrix(bitlen, vth, alpha, temp, sec)
    for A in range(-limit, limit):
        for B in range(-limit, limit):
            pd = get_monte_pd(A, B, bitlen, fa_delay)
            if pd > max_ps_delay:
                error_counter += 1
    
    

    return error_counter / length

########################################################################################
################## MAIN
########################################################################################


"""delay of the samples"""
if False and (__name__ == "__main__"):
    res = []

    log.println(f"RUNNING: monte carlo bit {BIT_LEN} for process variation")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"config/SAMPLE: {SAMPLE}")
    log.println(f"config/REW_LST: [{len(REW_LST)}] {REW_LST}")

    alpha = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=REW_LST)
    for sample_id in range(SAMPLE):
        delay = get_monte_MP_delay(sample_id, path_lst, alpha, TEMP, AGE_TIME)
        res.append(delay)

        if sample_id % 10_000 == 0:
            log.println(f"REW_LEN [{len(REW_LST)}]: sample [{sample_id:10,}/{SAMPLE:10,}] DONE")


    log.println(f"REW LEN: {len(REW_LST)}")
    log.println(f"min: {min(res)}, max: {max(res)}, average {sum(res)/len(res)}")
    log.println(f"raw result: \n{res}")
    
    # delay from 0-1000 as counter, each delay increase by one
    _sample_per_delay = [0 for _ in range(2000)]
    for delay in res:
        _sample_per_delay[int(delay)] += 1
    log.println(f"_sample_per_delay:\n{_sample_per_delay} \n")


if False and (__name__ == "__main__"):
    MIN_ALPHA = 0.1
    MAX_ALPHA = 0.9
    res = []

    log.println("-"*20)
    log.println(f"RUNNING: monte carlo bit {BIT_LEN} with dynamic input alpha")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"confing/IN_ALPHA_SAMPLE: {IN_ALPHA_SAMPLE}")
    log.println(f"config/SAMPLE: {SAMPLE}")
    log.println(f"config/REW_LST: [{len(REW_LST)}] {REW_LST}")
    log.println("-"*20)

    for in_alpha_i in range(IN_ALPHA_SAMPLE):
        random.seed(in_alpha_i)
        a_alpha = [random.uniform(MIN_ALPHA, MAX_ALPHA) for _ in range(BIT_LEN)]
        b_alpha = [random.uniform(MIN_ALPHA, MAX_ALPHA) for _ in range(BIT_LEN)]
        in_alpha = {'A': a_alpha, 'B': b_alpha}
        
        alpha = get_monte_alpha(MPn_rew, BIT_LEN, ALPHA_COUNTING_SAMPLE, in_alpha, in_alpha_i, rew_lst=REW_LST)
        
        for sample_id in range(SAMPLE):
            delay = get_monte_MP_delay(sample_id, path_lst, alpha, TEMP, AGE_TIME)
            res.append(delay)
        log.println(f"- [{len(REW_LST)}] ALPHA[{in_alpha_i}] DONE")

    log.println(f"REW LEN: {len(REW_LST)}")
    log.println(f"[{len(REW_LST)}] min {min(res)}, max {max(res)}, average {sum(res)/len(res)}")
    log.println(f"raw result: \n{res}")

    _sample_per_delay = [0 for _ in range(2000)]
    for delay in res:
        _sample_per_delay[int(delay)] += 1
    log.println(f"[{len(REW_LST)}] _sample_per_delay:\n{_sample_per_delay}")




"""error rate of the samples"""
if True and (__name__ == "__main__"):

    log.println(f"RUNNING: monte carlo bit {BIT_LEN} for error rate")
    log.println(f"config/ALPHA_COUTING_SAMPLE: {ALPHA_COUNTING_SAMPLE}")
    log.println(f"config/SAMPLE: {SAMPLE}")
    log.println(f"config/REW_LST: [{len(REW_LST)}] {REW_LST}")
    
    no_tamper_delay = [
        477.35, 534.24, 547.87, 557.69, 565.89, 572.82, 578.58, 584.18, 589.20, 593.94, 598.05, 602.76, 606.66, 609.88, 613.92, 617.52, 620.78, 623.65, 626.86, 629.78, 632.75, 635.52, 638.58, 640.86, 643.97, 646.78, 649.78, 652.22, 654.19, 656.48, 659.25, 661.44, 663.93, 666.52, 668.34, 670.71, 672.82, 674.94, 677.14, 678.88, 681.72, 683.27, 684.79, 687.20, 689.24, 691.50, 693.09, 694.91, 696.45, 699.09, 700.70, 702.25, 703.91, 706.24, 708.40, 709.93, 711.43, 713.06, 714.63, 716.28, 719.04, 720.58, 722.27, 723.74, 725.56, 727.66, 729.31, 730.46, 732.06, 733.47, 735.05, 737.62, 739.16, 740.23, 741.18, 742.74, 744.20, 745.59, 747.61, 749.34, 750.78, 752.32, 753.55, 754.30, 755.81, 756.99, 759.17, 761.05, 762.68, 763.30, 764.85, 766.36, 767.60, 768.44, 770.63, 771.92, 773.57, 775.31, 775.93, 777.53, 779.02, 780.96, 781.68, 782.89, 784.46, 785.18, 786.66, 788.52, 790.01, 790.58, 791.98, 794.01, 794.70, 795.93, 797.28, 798.12, 799.60, 801.31, 801.97, 803.37, 805.24, 805.96, 807.49, 807.95, 809.46, 810.75, 811.61, 812.66, 814.70, 815.21, 816.79, 817.22, 819.62, 820.79, 821.65, 822.80, 823.60, 824.66, 825.64, 826.72, 828.61, 829.14, 831.59, 832.03, 833.48, 834.01, 835.42, 836.76, 837.43, 838.73, 839.48, 840.67, 841.45, 842.67, 843.78, 845.82, 846.22, 847.90, 848.13, 849.72, 850.03, 851.54, 852.76, 853.60, 854.99, 855.28, 857.41, 857.96, 859.71, 860.36, 861.79, 862.26, 863.39, 864.08, 864.49, 865.87, 866.41, 867.89, 868.35, 869.44, 870.29, 872.14, 873.12, 874.48, 874.78, 876.40, 876.87, 878.40, 878.93, 880.13, 880.71, 881.39, 882.74, 883.22, 885.30, 885.88, 887.16, 887.87, 889.01, 889.44
    ]
    
    alpha = get_alpha(MPn_rew, BIT_LEN, log=False, rew_lst=REW_LST)
    def RUN(age_time):
        res = []
        for sample_id in range(SAMPLE):
            delay_margin = no_tamper_delay[age_time] * 1.10
            age_time_sec = age_time *7 *24*60*60

            vth_matrix = generate_guassian_vth_base(BIT_LEN, seed=seed_generator(sample_id))
            error_rate = get_monte_error_rate(BIT_LEN, vth_matrix, alpha, TEMP, age_time_sec, delay_margin)
            res.append(error_rate)

        log.println(f"REW [{len(REW_LST)}] age_time [{age_time:3}], min: {min(res)}, max: {max(res)}, average {sum(res)/len(res)}")
        # log.println(f"raw result: \n{res}")
        
    for age_time in range(AGE_TIME):
        RUN(age_time)
    
    # delay from 0-1000 as counter, each delay increase by one
    # _sample_per_delay = [0 for _ in range(2000)]
    # for delay in res:
    #     _sample_per_delay[int(delay)] += 1
    # log.println(f"_sample_per_delay:\n{_sample_per_delay} \n")
